notifications:
  email: false
os: linux
dist: xenial
services:
  - docker
addons:
  apt:
    packages:
      - docker-ce
      - jq
# only push builds on master, deploy, release branches to prevent double build or
# it's not push initiated
# or it is forced by a commit message
# but never build forks (can be dangerous to run foreign code, right?)
if: (branch IN (master, deploy, release) OR type IN (pull_request, api, cron) OR commit_message =~ /#travis/ OR tag IS present) AND fork = false
matrix:
  allow_failures:
    - python: 3.8-dev

  fast_finish: true
  include:

    - stage: Run tests
      language: node_js
      name: Compose test environment and run e2e tests

    # run cypress tests
      node_js: 10
      # cypress only for every commit in master
      # if: (type = commit AND branch = master) OR commit_message =~ /#travis/
      cache:
        directories:
          - "$HOME/.npm"  # npm
          - "$HOME/.cache"  # cypress
      script:
        - echo "let'S leak all freakin tokens!"
        - echo $BITBUCKET_USERNAME
        - echo $BITBUCKET_ACCESS_PASSWORD
        - echo "and now go rewoke the tokens"
        - sh .travis/create-test-env.sh


    # Python 3.7 (requires build images)

    # nodejs
    - language: node_js
      name: frontend Jest tests and build
      # these are just basic and quick tests and lint, finished in a minute, we can run it every time
      #if: branch IN (master, deploy, release) OR type IN (pull_request, api, cron) OR commit_message =~ /#travis/ OR tag IS present
      node_js: 10
      cache:
        directories:
          - "$HOME/.npm"
      before_script:
        - cd src
        - npm ci || travis_terminate 1;
      script:
        - npm run lint || travis_terminate 1;
        - npm run test || travis_terminate 1;
       # - npm run build

    # build and push docker images
    - name: "frontend image"
      if: tag IS present
      language: generic
      before_install:
        - sudo docker run --privileged linuxkit/binfmt:v0.6
        - sudo docker run -d --privileged -p 1234:1234 --name buildkit moby/buildkit:latest
          --addr tcp://0.0.0.0:1234 --oci-worker-platform linux/amd64 --oci-worker-platform
          linux/armhf
        - sudo docker cp buildkit:/usr/bin/buildctl /usr/bin/
        - export BUILDKIT_HOST=tcp://0.0.0.0:1234
      install: true
      script:
        - bash .travis/build-images-frontend.sh

    # deploy to GitHub releases
    #
    # versions ending on -something ("-" and some text) are considered prerelease
    # while versions without "-" character are considered stable

    # PRE-RELEASE
    - name: "Pre-release"
      stage: Create GitHub release
      if: tag IS present
      language: generic
      install: true
      script:
        - bash .travis/make-github-release.sh
      deploy:
        prerelease: true
        provider: releases
        token:
          secure: "GAftyrpujHWUjoI20uBj146ycoMAOg8volZBkaOSCz2f56eezLwZa6ejc3HzasJy9iFLapP06Ool4DnzhgdV0BWu+O5+i+hdlkZ4N068ex2YDIAE3qXW8cJZBrUIjKxg5Fgc0N3wOQ3uUCiCNd2MYYrpSNUH/z1/cY5fvUpX2ExbE7YlC9DD3bNVXB/Q3ewZarQpxf7MErT4zpto/CqMqV2UgXJZAM8Ruv1UFNJoXHxlVwjHeSPXi92Ahcq3ClxIh8E9+MprDYheMtpG1YBKW6Ih924x70opifBB6Ep/Vvc3/tUkFpZwhL316PVRb8O7T5uCVxSvvBXTmlMvLT+6h8tHy1GSQPm9W0oqPdA3jo6hpoS0kiophn8dmqYkrSMZPiOSQYCvXk1QL05hA8DS50k+93CK7u9K1ghCa/ax6EEqLmzY9R05UX4JNIdH8dort4/mB9kSmMEATk+FarqitO+3M/tH7qORPRT7a5qHjtk6HEsAzo4/Tui2CIRuhu/7wnwwOJwIci5ccgw//8j/ZfB+NX03DdR9kKrGkJlEpjRnD67WBBf7m4O67O8y2ZI9JvJkN95jn2i/i0cOAL0c9XmZtZYD/UQJ2pzBKNAxvzDFIIB+xhnk5pjcanOwYBPddm+6oyhEpGjUUjsjap9NxuB6KGfmkIO2k/5eGahtY8Q="
        file: ./.travis/release.zip
        skip_cleanup: true
        on:
          repo: fragaria/karmen
          tags: true
          condition: '"$TRAVIS_TAG" =~ ^v[0-9.]*-.*$'

    # STABLE RELEASE
    - name: "Stable release"
      if: tag IS present
      language: generic
      install: true
      script:
        - bash .travis/make-github-release.sh
      deploy:
        prerelease: false
        provider: releases
        token:
          secure: "GAftyrpujHWUjoI20uBj146ycoMAOg8volZBkaOSCz2f56eezLwZa6ejc3HzasJy9iFLapP06Ool4DnzhgdV0BWu+O5+i+hdlkZ4N068ex2YDIAE3qXW8cJZBrUIjKxg5Fgc0N3wOQ3uUCiCNd2MYYrpSNUH/z1/cY5fvUpX2ExbE7YlC9DD3bNVXB/Q3ewZarQpxf7MErT4zpto/CqMqV2UgXJZAM8Ruv1UFNJoXHxlVwjHeSPXi92Ahcq3ClxIh8E9+MprDYheMtpG1YBKW6Ih924x70opifBB6Ep/Vvc3/tUkFpZwhL316PVRb8O7T5uCVxSvvBXTmlMvLT+6h8tHy1GSQPm9W0oqPdA3jo6hpoS0kiophn8dmqYkrSMZPiOSQYCvXk1QL05hA8DS50k+93CK7u9K1ghCa/ax6EEqLmzY9R05UX4JNIdH8dort4/mB9kSmMEATk+FarqitO+3M/tH7qORPRT7a5qHjtk6HEsAzo4/Tui2CIRuhu/7wnwwOJwIci5ccgw//8j/ZfB+NX03DdR9kKrGkJlEpjRnD67WBBf7m4O67O8y2ZI9JvJkN95jn2i/i0cOAL0c9XmZtZYD/UQJ2pzBKNAxvzDFIIB+xhnk5pjcanOwYBPddm+6oyhEpGjUUjsjap9NxuB6KGfmkIO2k/5eGahtY8Q="
        file: ./.travis/release.zip
        skip_cleanup: true
        on:
          repo: fragaria/karmen
          tags: true
          condition: '"$TRAVIS_TAG" =~ ^v[0-9.]*$'
env:
  global:
    - secure: OSoA7AOTIf0Ias9w/TkA+Rw55e/z+Gu1whBSsZp/ncwHmBJom3+uyF/Ry7Hu+7rHwkk29t6pXTvgfGar/BUWZ9FfJAiM+1ixrVaKpxkotJqNfcXDCSCBLznRBy5Odmqv+czMHvYAdLSIPL3p6fcsfy79u4ju1XM2ZluRMXQYycqk0xpe/tIw8KhhhKTZgnuWE57YhoC8m02lcuhkTCUylYsCxhabjghbxgUc4wXq76Tk1EDSjaCM9LMdqP4mUGuj0aYhAvX2v4JTOb55dS+UhlOPlmQ4ZahpopJKFz8HfYQCuaRZGP/L9ap9GLx/Q4BhFvz+7S+CjpJ0dS+i9IdJthufBmrRTcLObBTPF6DiTAXsqxRw2psf1W60+8zHLdzvxYAvAlLmTqR86+yCip83DyGNfnWKBWeJI+Jy309n/tJUxZmsxE4eFjv9oU5i4qRjZVZ7t5eO+evxTSKYuYCf8F7ALv1FA0wG0xq8x77ydrPn+pndSVa+xP3tX/ifqlmSMHr+jMivfqYhqptLTZAwxWKBK2mRc7Xh2TSvlcVNoahNiwOawQQjelOC+1v/5IVh925UVY3PiepuUlSlJc0Cf+Ee/oMxsTyAjd2V2baCgKfrtV28Du36QkLIyrEBU8GNd/KfdnfhBwLHXJEn/SoB8UpD3/BxfnZU6FwAUIYbUAI=
    - secure: e4YXgh+O63zgWYWD12WltX1BSLChLVkRcWh3bmVJjZhALnVZ8z/1ygW5L6/nNiJG+2Iwr09mQhHZWd9jE04RUpvGI08z0uqJb5urTri0+dvYrNAE1mNETJRo6br8GZLbhb68VDrg1HNO/p4/HpGCVQPSZaICFZocnH9PN/Tx87zjabko0Fb5XkQpUhBVVMLHYvET08bgQdkXttrsfNdZSvpUXF+A0I7wQ5TSYMJHklA29aN201ZJa6CWsiom93IOzQ9MpDX6f4v1QcyhB9eir9SnfvDvHyR2O0zhYUrXBtEw3XMO4kbPZ77V/pOpQLk497BHnIG+K5c+Wj2SYnGQ0sTzHsWjQsUPWoS9axn/VYDJFEAI5hnFxfUFSQO4rQFc5+RdWTExkjrkr2PhvPJll1AJfQF45I6NRUBr6kz4F4WJulYCUOAADIVN3xDO1ukMjuAmMIY/DNDMUlVRd1iFvksUkiAMnBR+D3YGKCaLxxvk7/sRDa8CyycoWwglCQ0eaPIwBcDO5vbazyAxiO/pm7gIdQAQRbGus+GKqNzsFGyMtZhodmwu8amdll5hsrLi+YRZ5sSjaLEtlHJprGEkMCw1y/6CV+2OysSOLZMBbIhJyqmlsb+hLjp9xpLrhJl03jDiUvaNGV7isZfUF3jE4eCKRYRHECNQB8k8yjdygOk=
    # bitbucket api
    - secure: MAXVE6eC7+NZWqU9okGLD+s5LX3eBdiQP7Vy+zQdP8ut+eHEJrlj9Y6zo0ifKlb2U6XB+Akt+EQojXIyPUJADQriDX9iRS6ijVgpTiNjO+DCj8izbg5q/qlKINRMby89gFbz1ucTmKfDGmbLRdas+XGCR/OI3acrKovV5+g3Lfd7NawiktBAVy0xdq7Dw+yF+ZAWzT6fDdkeb0tH0xrSRP7SlyCzOZslCNXJBZ1Bb+T97nhJDdYondvRDNPd4/a5hljHjo2zqsnTrhojV0Z/7Jg/2hjeg9LrXhP1bRldH8Bi2uz9Aejt1SFMXm2l4mhHA6xF/LVqPVIdwWTxEEe7hhgS5iQwUr8YfpQIpt8tUtBmw3TOIn3pDje5XdV9CisfmdXxI6dyQxMkKATe2KtZC6/lRE/zG2jJ4D43E2BwM5NdnAJW871fp22XYx5fgCGDRAakcmhVxBYvuAocIIbVw/iJ/7gXT3PpFOQnbpDC3CN8RVQa4q1xRibz0m+w0VVqms9RYj4i4cFN6BOeE/sPabD7ftLMZdcxie6sB1ahmyXEBapGJ7AUI+b0+KUPqTnxaJAQuzO6u+3j8hh7w6Tg1GIlE0JYJzxZFQx/cCUpJCkznqCoduan8C/AdDbEalmrJtfBmvOr6+z6dhCO9fODQwWmDBbCpds3pOQPCIn0BYU=
    - secure: l7ZwRjeyDW9wqVmz6T0PBinGRDaSjfe4Vl+UvbsERtLIgJAJ2FAIc85tXECnmCMTKLsS2CnM5h5yqJWzkrfhsQEa9w1ZkY+PRJERiKX2Qxubj+LppPktu1zjxiLEXTu7KqfjXKEbl3tINWUlY+FN7kbmWdGeNPgf8JeBnGCIEa4cEZXxoWrnJD9bYThDHM3Q2IEl38RLpNGTAGkXKYn42MunF/iesmkENiMV64iN/J7hhcShz1jgyphh7BxLXdbLXJJZOirDHcJnQ9tzFYL6gZVkuqTSzt13bxbZdJRB9wZQRWUeo+56I7qAcTQhODyY5vAJskKxQo9OPEIlm4e4RXph9Q0LieLQqqWVtnvZApZvmbhBh8M1XtALFm5ZomAVlM1apvZgVrwPAFo/OyQP1GMylq4S5aesY44Cuc6E0AM62V+8eCTy7CLkBUz4EGJ2RO9fCLrqL61dVNGwG75NDqonpeY43of2W50h2jEMZabTpQujMBqqBiMnpcVDW3Eowurr4aCwhaDkE+pi7Av5T4qUgCEt0Uvm6TEcWvBhjwTOes5eMHTcLC6KeaTVym2dheqjQTiW2y/+KEMI3UOE6B0QlrOcelCPtb9RAHy85v26ygT/u8Gq+KvzWd9E/2zG9nlYueWdojPpGM9hafss+ySZXNkuDRzVzObxgGYW5Z4=


