openapi: 3.0.0
info:
  version: '0.9.0'
  title: 'Karmen API'
  description: 'API of https://github.com/fragaria/karmen'
tags:
  - name: printers
    description: Printers endpoints
  - name: users-me
    description: Auth endpoints
paths:
  '/organizations/{org_uuid}/printers/{printer_uuid}':
    get:
      summary: Return printer data
      operationId: server.routes.printers.printer_detail
      tags:
        - printers
      parameters:
        - $ref: '#/components/parameters/printer_uuid_param'
        - $ref: '#/components/parameters/organization_uuid_param'
      responses:
        '200':
          description: 'OK, printer object is returned'
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/printer_response'
        '404':
          description: >-
            Printer not found. It either doesn't exists, or is not in this
            organization
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/api_err_response'
              example:
                message: Not found
        '400':
           $ref: '#/components/responses/invalid_UUID'
    patch:
      summary: Change printer properties, update name or change API key
      operationId: server.routes.printers.printer_patch
      tags:
        - printers
      parameters:
        - $ref: '#/components/parameters/printer_uuid_param'
        - $ref: '#/components/parameters/organization_uuid_param'
      responses:
        '200':
          description: 'OK, printer object is returned'
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/printer_response'
        '404':
          description: >-
            Printer not found. It either doesn't exists, or is not in this
            organization
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/api_err_response'
              example:
                message: Not found
        '400':
          description: Could not update printer
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/api_err_response'
              examples:
                no_payload:
                  summary: Missing payload
                  description: no payload was sent
                  value:
                    message: Missing payload
                missing_name:
                  summary: name field is missing or empty
                  description: Sent payload was missing name field or it has zero length. Name is always required.
                  value:
                    message: Missing name
    delete:
      summary: Delete printer
      operationId: server.routes.printers.printer_delete
      tags:
        - printers
      parameters:
        - $ref: '#/components/parameters/printer_uuid_param'
        - $ref: '#/components/parameters/organization_uuid_param'
      responses:
        '204':
          description: 'OK, printer deleted'

        '404':
          description: >-
            Printer not found. It either doesn't exists, or is not in this
            organization
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/api_err_response'
              example:
                message: Not found
        '400':
          $ref: '#/components/responses/invalid_UUID'

  '/organizations/{org_uuid}/printers':
    get:
      summary: Get list of printers in organization
      operationId: server.routes.printers.printers_list
      tags:
        - printers
      parameters:
        - $ref: '#/components/parameters/organization_uuid_param'
      responses:
        '200':
          description: 'OK, list of printer objects is returned'
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/printer_response'
        '400':
           $ref: '#/components/responses/invalid_UUID'
        '403':
          description: >-
            User is not a member of this organization, or it doesn't exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/api_err_response'
              example:
                message: Cannot access this organization
    post:
      summary: Create printer
      operationId: server.routes.printers.printer_create
      tags:
        - printers
      description: >-
        Post to this endpoint to create a printer. In CLOUD_MODE, you can add printer by token.
        In non-CLOUD mode, printer must be added by network properties.
      parameters:
        - $ref: '#/components/parameters/organization_uuid_param'
      requestBody:
        content:
          application/json:
            schema:
              oneOf:
                - $ref: '#/components/schemas/printer_by_token'
                - $ref: '#/components/schemas/printer_by_network_props'
            examples:
              by_token:
                summary: Printer added by token
                value:
                  name: Printer name
                  token: ABC123
                  protocol: https
                  api_key: ""
              by_net_props:
                summary: Printer added by network props
                value:
                  name: Printer name
                  ip: 192.1368.5.42
                  port: 80
                  hostname: karmen.local
                  path: ""
                  api_key: ""



      responses:
        '200':
          description: 'OK, printer_response is returned withou additional fields'
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/printer_response'
        '400':
          description: Could not create printer
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/api_err_response'
              examples:
                missing_token:
                  summary: Missing token
                  description: None or zero-length token was sent
                  value:
                    message: Missing token
                missing_net_data:
                  summary: Incomplete network data
                  description: You are trying to add printer in non-cloud mode, but not enough data to identify the printer in network was supplied.
                  value:
                    message: Missing some network data about the printer

        '409':
          description: >-
            Printer with this token or ip, port, path already exists in this organization
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/api_err_response'
              example:
                message: Printer exists
        '500':
          description: >-
            Erro while adding printer
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/api_err_response'
              examples:
                unresolved_hostname:
                  summary: Unresolved hostname
                  description:  You are trying to add printer via hostname, but the server was unable to resolve that hostname to an IP.
                  value:
                    message: Cannot resolve {hostname} with mDNS
                invalid_mode:
                  summary: Wrong CLOUD mode
                  description: You are trying to add printer in non-cloud mode, but not enough data to identify the printer in network was supplied.
                  value:
                    message: Cannot add printer without a token in CLOUD_MODE

  '/organizations/{org_uuid}/printers/{printer_uuid}/connection':
    post:
      summary: Change connections state
      operationId: server.routes.printers.printer_change_connection
      tags:
        - printers
      parameters:
        - $ref: '#/components/parameters/printer_uuid_param'
        - $ref: '#/components/parameters/organization_uuid_param'
      requestBody:

        content:
          application/json:
            schema:
              properties:
                state:
                  type: string
                  enum: [online, offline]
            examples:
              connect:
                value:
                  state: online
              disconnect:
                value:
                  state: offline

      responses:
        '204':
          description: 'OK'

        '400':
          description: >-
            Invalid state was sent
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/api_err_response'
              example:
                message: <state> is an uknown state
        '500':
          description: >-
            Cannot change printers state
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/api_err_response'
              example:
                message: Cannon change printer's connection state to <state>

  '/organizations/{org_uuid}/printers/{printer_uuid}/current-job':
    post:
      summary: Change  state of current job
      operationId: server.routes.printers.printer_modify_job
      tags:
        - printers
      parameters:
        - $ref: '#/components/parameters/printer_uuid_param'
        - $ref: '#/components/parameters/organization_uuid_param'
      requestBody:
        content:
          application/json:
            schema:
              properties:
                action:
                  type: string
                  enum: [cancel, pause, resume]
            examples:
              cancel current job:
                value:
                  action: cancel
              pause current job:
                value:
                  action: cancel
              resume paused job:
                value:
                  action: resume

      responses:
        '204':
          description: 'OK'

        '400':
          description: >-
            Invalid state was sent
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/api_err_response'
              examples:
                Missing action:
                  value:
                    message: Missing action
                No job to modify:
                  value:
                    message: Nothing is running
                Generic printer error:
                  value:
                    message: <<generic printer error from control software>>

  '/organizations/{org_uuid}/printers/{printer_uuid}/webcam-snapshot':
    get:
      summary: Get snapshot from webcam
      operationId: server.routes.printers.printer_webcam_snapshot
      tags:
        - printers
      parameters:
        - $ref: '#/components/parameters/printer_uuid_param'
        - $ref: '#/components/parameters/organization_uuid_param'
      responses:
        '200':
          description: 'OK, image is returned'
        '202':
          description: Karmen is initializing connection. Keep trying, image will be returned in following requests

        '404':
          description: >-
            Printer was not found or it doesn't have a webcam, or the image was not found at the expected url
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/api_err_response'
              example:
                message: Not found

  '/organizations/{org_uuid}/printers/{printer_uuid}/lights':
    post:
      summary: Change  state of printer light
      operationId: server.routes.printers.printer_set_lights
      tags:
        - printers
      parameters:
        - $ref: '#/components/parameters/printer_uuid_param'
        - $ref: '#/components/parameters/organization_uuid_param'
      requestBody:
        content:
          application/json:
            schema:
              properties:
                status:
                  type: string
                  enum: [on, off]
            examples:
              turn on:
                value:
                  status: on
              turn off:
                value:
                  status: off
      responses:
        '200':
          description: 'OK'
          content:
            application/json:
              schema:
                properties:
                  status:
                    type: string
                    enum: [on, off]

        '500':
          description: >-
            Light is no available on this printer
          content:
            application/json:
              schema:
                properties:
                  status:
                    type: string
                    enum: [unavailable]

  '/organizations/{org_uuid}/printers/{printer_uuid}/printhead':
    post:
      summary: Move printer head
      operationId: server.routes.printers.control_printhead
      tags:
        - printers
      parameters:
        - $ref: '#/components/parameters/printer_uuid_param'
        - $ref: '#/components/parameters/organization_uuid_param'
      requestBody:
        content:
          application/json:
            schema:
              properties:
                command:
                  type: string
                  enum: [jog, home]
                x:
                  type: integer
                y:
                  type: integer
                z:
                  type: integer
                absolute:
                  type: boolean
                axes:
                  type: array

            examples:
              move X by 10 cm:
                value:
                  command: jog
                  x: 10
                  absolute: false
              move Y by -10 cm:
                value:
                  command: jog
                  z: -10
                  absolute: false
              home X and Y:
                value:
                  command: home
                  axes: [x, y]

      responses:
        '204':
          description: 'OK'

        '400':
          description: >-
            Unable to process
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/api_err_response'
              examples:
                Invalid distance:
                  value:
                    message: Distance on <axis> must be a number
                Invalid axis:
                  value:
                    message: <axis> is not a valid axes value
                Unknow command:
                  value:
                    message: Unknown command
                No list of axes to home was sent:
                  value:
                    message: Missing axes

        '500':
          description: >-
            Printer refued to move
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/api_err_response'
              example:
                message: Cannot mode printhead

  '/organizations/{org_uuid}/printers/{printer_uuid}/fan':
    post:
      summary: Change  state of printer fan
      operationId: server.routes.printers.control_fan
      tags:
        - printers
      parameters:
        - $ref: '#/components/parameters/printer_uuid_param'
        - $ref: '#/components/parameters/organization_uuid_param'
      requestBody:
        content:
          application/json:
            schema:
              properties:
                target:
                  type: string
                  enum: [on, off]
            examples:
              turn on:
                value:
                  target: on
              turn off:
                value:
                  target: off
      responses:
        '204':
          description: OK
        '400':
          description: >-
            Target is not on or off
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/api_err_response'
              example:
                message: Invalid target

        '500':
          description: >-
            Printer refused to control fan
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/api_err_response'
              example:
                message: Cannot control fan

  '/organizations/{org_uuid}/printers/{printer_uuid}/motors':
    post:
      summary: Disable motors
      operationId: server.routes.printers.control_motors
      tags:
        - printers
      parameters:
        - $ref: '#/components/parameters/printer_uuid_param'
        - $ref: '#/components/parameters/organization_uuid_param'
      requestBody:
        content:
          application/json:
            schema:
              properties:
                target:
                  type: string
                  enum: [ off]
            examples:
              disable:
                value:
                  target: off
      responses:
        '204':
          description: OK
        '400':
          description: >-
            Target is not off
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/api_err_response'
              example:
                message: Invalid target

        '500':
          description: >-
            Printer refused to control motors
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/api_err_response'
              example:
                message: Cannot control motors

  '/organizations/{org_uuid}/printers/{printer_uuid}/extrusion':
    post:
      summary: Extrude or retrract filament
      operationId: server.routes.printers.control_extrusion
      tags:
        - printers
      parameters:
        - $ref: '#/components/parameters/printer_uuid_param'
        - $ref: '#/components/parameters/organization_uuid_param'
      requestBody:
        content:
          application/json:
            schema:
              properties:
                target:
                  type: string
                  enum: [on, off]
            examples:
              turn on:
                value:
                  target: on
              turn off:
                value:
                  target: off
      responses:
        '204':
          description: OK
        '400':
          description: >-
            Target is not on or off
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/api_err_response'
              example:
                message: Invalid target

        '500':
          description: >-
            Printer refused to control fan
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/api_err_response'
              example:
                message: Cannot control fan

  '/organizations/{org_uuid}/printers/{printer_uuid}/temperatures/{part_name}':
    post:
      summary: Set temperatures for part
      operationId: server.routes.printers.control_tool_temperature
      tags:
        - printers
      parameters:
        - $ref: '#/components/parameters/printer_uuid_param'
        - $ref: '#/components/parameters/organization_uuid_param'
        - in: path
          name: part_name
          schema:
            type: string
            enum: [tool0, tool1, bed]
          required: true
          description: Part to set semperature


      requestBody:
        content:
          application/json:
            schema:
              properties:
                target:
                  type: number
              required:
                - target

            example:
              target: 60.0

      responses:
        '204':
          description: 'OK'

        '400':
          description: >-
            Unable to process
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/api_err_response'
              examples:
                Invalid part:
                  value:
                    message: <part_name> is not a valid part choice
                Invalid temperature:
                  value:
                    message: Target must be a number
                Negative temp:
                  value:
                    message: Cannot set negative temperature


        '500':
          description: >-
            Printer refued to set temo
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/api_err_response'
              example:
                message: Cannot set temperature

  '/organizations/{org_uuid}/printers/{printer_uuid}/update':
    post:
      summary: Start update
      operationId: server.routes.printers.start_pill_update
      tags:
        - printers
      parameters:
        - $ref: '#/components/parameters/printer_uuid_param'
        - $ref: '#/components/parameters/organization_uuid_param'

      responses:
        '200':
          description: 'OK'

        '400':
          description: >-
            Unable to process
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/api_err_response'
              examples:
                Not a pill:
                  value:
                    message: The automatic update is supported on original Pill devices only.
                No update available:
                  value:
                    message: pdate is not available for the device.

        '500':
          description: >-
            Pill was unable to start an update.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/api_err_response'
              example:
                message: Unable to start update

components:
  parameters:
    printer_uuid_param:
      name: printer_uuid
      in: path
      required: true
      schema:
        type: string
    organization_uuid_param:
      name: org_uuid
      in: path
      required: true
      schema:
        type: string
    printjob_uuid_param:
      name: printjob_uuid
      in: path
      required: true
      schema:
        type: string
    user_uuid_param:
      name: user_uuid
      in: path
      required: true
      schema:
        type: string
    gcode_uuid_param:
      name: gcode_uuid
      in: path
      required: true
      schema:
        type: string
    jti:
      name: jti
      in: path
      required: true
      schema:
        type: string
  schemas:
    api_err_response:
      type: object
      properties:
        message:
          type: string
    printer_response:
      type: object
      properties:
        client:
          type: object
          properties:
            access_level:
              type: string
              enum: [unlocked, locked, unknown]
              example: unlocked
            api_key:
              type: string
              example: ABCDEFXXXX123456
            connected:
              type: boolean
              example: true
            name:
              type: string
              example: octoprint
            pill_info:
              type: object
              properties:
                karmen_version:
                  type: string
                  example: 0.2.0
                update_available:
                  type: string
                  example: 0.2.2
                update_status:
                  type: string
                  example:
                version_number:
                  type: string
                  example: 0.2.0
            plugins:
              type: array
              items:
                type: string
              example: [karmen_awesome_led]
            version:
              type: object
              properties:
                api:
                  type: string
                  example: 0.1
                server:
                  type: string
                  example: 0.0.1
                text:
                  type: string
                  example: octoprint fake
        hostname:
          type: string
          example: karmen_printer.local
        ip:
          type: string
          example: 192.168.1.42
        job:
          type: object
          properties:
            completion:
              type: number
              example: 42.42
            name:
              type: string
              example: holder_print.gcode
            printTime:
              type: number
              example: 3066
            printTimeLeft:
              type: number
              example: 6060
        lights:
          type: string
          enum: [off, on, unavailable]
          example: on
        name:
          type: string
          example: fake priter 1
        path:
          type: string
          example: ""
        port:
          type: integer
          example: 80
        printer_props:
          type: object
          properties:
            bed_type:
              type: string
              example: Powder coated PEI
            filament_color:
              type: string
              example: black
            filament_type:
              type: string
              example: PETG
            tool0_diameter:
              type: number
              example: 0.25
        protocol:
          type: string
          example: https
          enum: [http, https]
        status:
          type: object
          properties:
            state:
              type: string
              example: Printing
            temperature:
              type: object
              properties:
                bed:
                  type: object
                  properties:
                    actual:
                      type: number
                      example: 35.7
                    target:
                      type: number
                      example: 60
                tool0:
                  type: object
                  properties:
                    actual:
                      type: number
                      example: 35.7
                    target:
                      type: number
                      example: 270
        token:
          type: string
          example:
        uuid:
          type: string
          example: 20e91c14-c3e4-4fe9-a066-e69d53324a20
        webcam:
          type: object
          properties:
            flipHorizontal:
              type: boolean
              example: false
            flipVertical:
              type: boolean
              example: false
            rotate90:
              type: boolean
              example: false
            url:
              type: string
              example: "/organizations/b3060e41-e319-4a9b-8ac4-e0936c75f275/printers/20e91c14-c3e4-4fe9-a066-e69d53324a20/webcam-snapshot"
    printer_by_token:
      type: object
      properties:
        name:
          type: string
          example: My printer
        token:
          type: string
          example: ABC123ABC
        api_key:
          type: string
          example: ""
        protocol:
          type: string
          example: http
          enum: [http, https]
      required:
        - name
        - token
        - protocol
    printer_by_network_props:
      type: object
      properties:
        protocol:
          type: string
          example: http
          enum: [http, https]
        ip:
          type: string
          example: 192.168.5.42
          format: ipv4
        port:
          type: integer
          example: 80
        hostname:
          type: string
          example: karmen.local
          format: hostname
        path:
          type: string
          example: ""
        name:
          type: string
          example: My Printer
        api_key:
          type: string
          example: ""
      required:
        - name
        - protocol
        - path
        - port
        - api_key


  responses:
    invalid_UUID:
        description: >-
          Supplied UUID param was not valid UUID
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/api_err_response'
            example:
              message: Invalid uuid